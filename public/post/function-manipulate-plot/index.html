<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Functional Programming in {data.table} and {ggplot2} with bquote()">
  <meta name="generator" content="Hugo 0.49" />

  <title>One Function Call to Manipulate and Plot Them All &middot; The Amateur Data Scientist</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/zenburn.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="/">recleev</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/recleev" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://facebook.com/recleev" target="_blank"><i class="fa fa-facebook-square fa-fw"></i>Facebook</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/recleev" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/recleev" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small></small>
  </div>
  <div class="small-print">
    <small>Built with <a href="https://github.com/rstudio/blogdown" target="_blank">blogdown</a> and <a href="https://gohugo.io/" target="_blank">Hugo</a>.</small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>One Function Call to Manipulate and Plot Them All</h1>
  <h2>Functional Programming in {data.table} and {ggplot2} with bquote()</h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2019 Jan 14</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="/tags/baser">baseR</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/bquote">bquote</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/data.table">data.table</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/function">function</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/ggplot2">ggplot2</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/quasiquotation">quasiquotation</a>
    
  </div>
  
  

</div>

  <div id="TOC">
<ul>
<li><a href="#motivation-to-automation"><span class="toc-section-number">1</span> Motivation to Automation</a></li>
<li><a href="#tidy-eval-with-rlang"><span class="toc-section-number">2</span> Tidy Eval with <code>rlang</code></a><ul>
<li><a href="#works-with-dplyr"><span class="toc-section-number">2.1</span> Works with <code>dplyr</code></a></li>
<li><a href="#fails-with-data.table"><span class="toc-section-number">2.2</span> Fails with <code>data.table</code></a></li>
</ul></li>
<li><a href="#quasiquotation-in-base-r"><span class="toc-section-number">3</span> Quasiquotation in <code>{base}</code>-<code>R</code></a></li>
<li><a href="#session-info"><span class="toc-section-number">4</span> Session Info</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<pre class="r"><code>xfun::pkg_attach(
  &quot;knitr&quot;,
  &quot;data.table&quot;,
  &quot;ggplot2&quot;,
  &quot;rlang&quot;,
  &quot;dplyr&quot;,
  &quot;magrittr&quot;,
  &quot;ggthemes&quot;
)

opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)

# Create a data.table version of the mtcars data set. I explicitly specified to exclude rownames just to be clear (The default in data.table is FALSE).
dt_mtcars &lt;- data.table(mtcars, keep.rownames = FALSE)

# Convert some columns from numeric to factor. I am not sure if this is the most
# efficient way to update multiple columns in data.table, but it works for my
# purposes.
dt_mtcars[
  ,
  c(&quot;cyl&quot;, &quot;vs&quot;, &quot;am&quot;, &quot;gear&quot;) := 
    lapply(.SD, factor),
  .SDcols = c(&quot;cyl&quot;, &quot;vs&quot;, &quot;am&quot;, &quot;gear&quot;)
]</code></pre>
<div id="motivation-to-automation" class="section level1">
<h1><span class="header-section-number">1</span> Motivation to Automation</h1>
<p>In my new role as a <a href="https://amateurdatasci.rbind.io/post/loves-what-he-is-doing/">junior data scientist</a>, I have to analyse and manipulate on a regular<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> basis using <code>R</code>. One common task I always do during exploratory data analysis until production is to check the effect or relationship of one or more exploratory variables to another in terms of a certain metric or summary of a response variable.</p>
<p>For example,</p>
<pre class="r"><code>dt_mtcars[
  ,
  .(disp_avg = mean(disp)),
  .(cyl, vs, am, gear)
] %&gt;% 
  ggplot(
    aes(gear, disp_avg, fill = cyl)
  ) +
  geom_col(position = &quot;dodge&quot;) +
  facet_wrap(
    vars(vs, am),
    ncol = 2,
    scales = &quot;free&quot;
  ) +
  scale_fill_pander() +
  theme_minimal()</code></pre>
<p><img src="/post/2019-01-14-function-manipulate-plot_files/figure-html/sample-factors-metric-plot-1.png" width="672" /></p>
<p>This is an easy enough plot to do, but what if I wanted to look at a different metric instead of the average, or a different response variable? What if I wanted to have a different set of explanatory variables, or I want different variables on the x-axis, fill, and facets? It gets too repetitive. When repition becomes apparent and burdensome, <strong>automate</strong>.</p>
</div>
<div id="tidy-eval-with-rlang" class="section level1">
<h1><span class="header-section-number">2</span> Tidy Eval with <code>rlang</code></h1>
<p>This is not an <code>rlang</code> <span class="citation">(Henry and Wickham 2018)</span> tutorial, I don’t think I am the best person to discuss what tidy evaluation is and how <code>rlang</code> works<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>. I will just give a quick walk through of my code using <code>rlang</code> in <code>ggplot2</code> <span class="citation">(Wickham et al. 2018)</span>.</p>
<div id="works-with-dplyr" class="section level2">
<h2><span class="header-section-number">2.1</span> Works with <code>dplyr</code></h2>
<p>In one of my projects, I already made code to capture the workflow of data summary and plotting using <code>rlang</code> and <code>dplyr</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-dplyr"><strong>???</strong></span>)</span>.</p>
<pre class="r"><code>plot_with_dplyr_rlang &lt;- function(
  data_tibble, 
  x, y, fill, 
  facet_1, facet_2
) {
  # Quote column names in arguments
  x &lt;- rlang::enquo(x)
  y &lt;- rlang::enquo(y)
  fill &lt;- rlang::enquo(fill)
  facet_1 &lt;- rlang::enquo(facet_1)
  facet_2 &lt;- rlang::enquo(facet_2)
  
  data_tibble %&gt;% 
    # All the !! are necessary to retrieve the variable name stored in the
    # arguments. Group by explanatory variables
    dplyr::group_by(!!x, !!fill, !!facet_1, !!facet_2) %&gt;% 
    # Compute average of response variable
    dplyr::summarise(y_avg = mean(!!y)) %&gt;% 
    ggplot2::ggplot(
      ggplot2::aes(
        x = !!x,
        y = y_avg,
        fill = !!fill
      )
    ) +
    geom_col(position = &quot;dodge&quot;) +
    facet_wrap(
      vars(!!facet_1, !!facet_2),
      ncol = 2,
      scales = &quot;free&quot;
    ) +
    scale_fill_pander() +
    theme_minimal() 
}

dt_mtcars %&gt;% 
  plot_with_dplyr_rlang(
    gear,
    disp,
    fill = cyl,
    facet_1 = vs,
    facet_2 = am
  )</code></pre>
<p><img src="/post/2019-01-14-function-manipulate-plot_files/figure-html/dplyr-rlang-ggplot2-1.png" width="672" /></p>
<p>The combination of <code>dplyr</code>, <code>rlang</code>, and <code>ggplot2</code> works very well with what I want to do.</p>
</div>
<div id="fails-with-data.table" class="section level2">
<h2><span class="header-section-number">2.2</span> Fails with <code>data.table</code></h2>
<p>However, as a matter of personal preference, I want to use <code>data.table</code> <span class="citation">(Dowle and Srinivasan 2018)</span> for my data wrangling and manipulation. I did not expect <code>rlang</code> to work with <code>data.table</code> since it was made for tidy eval, but I tried anyway.</p>
<pre class="r"><code>plot_with_data.table_rlang &lt;- function(
  data_data.table,
  x, y,
  fill, facet_1, facet_2
) {
  # Quote column names in arguments
    x &lt;- rlang::enquo(x)
    y &lt;- rlang::enquo(y)
    fill &lt;- rlang::enquo(fill)
    facet_1 &lt;- rlang::enquo(facet_1)
    facet_2 &lt;- rlang::enquo(facet_2)
    
  data_data.table[
    ,
    # Compute average of response variable
    .(y_avg = mean(!!y)),
    # Group by explanatory variables
    .(!!x, !!fill, !!facet_1, !!facet_2)
  ] %&gt;% 
    ggplot2::ggplot(
        ggplot2::aes(
          x = !!x,
          y = y_avg,
          fill = !!fill
        )
      ) +
      geom_col(position = &quot;dodge&quot;) +
      facet_wrap(
        vars(!!facet_1, !!facet_2),
        ncol = 2,
        scales = &quot;free&quot;
      ) +
      scale_fill_pander() +
      theme_minimal()
} 

dt_mtcars %&gt;% 
  plot_with_data.table_rlang(
    gear,
    disp,
    fill = cyl,
    facet_1 = vs,
    facet_2 = am
  )</code></pre>
<pre><code>## Error in is_quosure(e2): argument &quot;e2&quot; is missing, with no default</code></pre>
<p>Again, I am not an <code>rlang</code> expert, so I am not sure why this does not work. A quick look at the code suggests it could have been at <code>rlang:::Ops.quosure()</code></p>
<p>I did a couple of more test to verify if <code>rlang</code> was not really compatible with <code>data.table</code>.</p>
<pre class="r"><code># I want to capture object names in objects, so I can refer to the captured
# objects in the objects with !!
average_this &lt;- as.name(&quot;disp&quot;)
group_with_this &lt;- as.name(&quot;cyl&quot;)

dt_mtcars %&gt;%
  group_by(!!group_with_this) %&gt;% 
  summarise(average = mean(!!average_this))</code></pre>
<pre><code>## # A tibble: 3 x 2
##   cyl   average
##   &lt;fct&gt;   &lt;dbl&gt;
## 1 4        105.
## 2 6        183.
## 3 8        353.</code></pre>
<pre class="r"><code>dt_mtcars[
  ,
  .(average = mean(!!average_this)),
  !!group_with_this
]</code></pre>
<pre><code>## Error in !group_with_this: invalid argument type</code></pre>
<p>This is not really as surprise as I don’t think both <code>rlang</code> and <code>data.table</code> was meant to work together. In any case, <code>rlang</code> is not the best solution to what I wanted to do with <code>data.table</code> and <code>ggplot2</code></p>
</div>
</div>
<div id="quasiquotation-in-base-r" class="section level1">
<h1><span class="header-section-number">3</span> Quasiquotation in <code>{base}</code>-<code>R</code></h1>
<p>I first learned about <code>bquote</code> from <span class="citation">Mount (n.d.)</span> <a href="http://www.win-vector.com/blog/2018/10/quasiquotation-in-r-via-bquote/">here</a>.</p>
</div>
<div id="session-info" class="section level1">
<h1><span class="header-section-number">4</span> Session Info</h1>
<pre class="r"><code>sessioninfo::session_info()</code></pre>
<pre><code>## - Session info ----------------------------------------------------------
##  setting  value                       
##  version  R version 3.5.2 (2018-12-20)
##  os       Windows 10 x64              
##  system   x86_64, mingw32             
##  ui       RTerm                       
##  language (EN)                        
##  collate  English_Philippines.1252    
##  ctype    English_Philippines.1252    
##  tz       Asia/Kuala_Lumpur           
##  date     2019-01-29                  
## 
## - Packages --------------------------------------------------------------
##  package     * version date       lib source                         
##  assertthat    0.2.0   2017-04-11 [1] CRAN (R 3.5.0)                 
##  bindr         0.1.1   2018-03-13 [1] CRAN (R 3.5.0)                 
##  bindrcpp      0.2.2   2018-03-29 [1] CRAN (R 3.5.0)                 
##  blogdown      0.10    2019-01-09 [1] CRAN (R 3.5.2)                 
##  bookdown      0.9     2018-12-21 [1] CRAN (R 3.5.2)                 
##  cli           1.0.1   2018-09-25 [1] CRAN (R 3.5.1)                 
##  colorspace    1.4-0   2019-01-13 [1] CRAN (R 3.5.2)                 
##  crayon        1.3.4   2017-09-16 [1] CRAN (R 3.5.0)                 
##  data.table  * 1.12.0  2019-01-13 [1] CRAN (R 3.5.2)                 
##  digest        0.6.18  2018-10-10 [1] CRAN (R 3.5.1)                 
##  dplyr       * 0.7.8   2018-11-10 [1] CRAN (R 3.5.1)                 
##  evaluate      0.12    2018-10-09 [1] CRAN (R 3.5.1)                 
##  fansi         0.4.0   2018-10-05 [1] CRAN (R 3.5.1)                 
##  ggplot2     * 3.1.0   2018-10-25 [1] CRAN (R 3.5.1)                 
##  ggthemes    * 4.0.1   2018-08-24 [1] CRAN (R 3.5.1)                 
##  glue          1.3.0   2018-10-03 [1] Github (tidyverse/glue@4e74901)
##  gtable        0.2.0   2016-02-26 [1] CRAN (R 3.5.0)                 
##  htmltools     0.3.6   2017-04-28 [1] CRAN (R 3.5.0)                 
##  knitr       * 1.21    2018-12-10 [1] CRAN (R 3.5.1)                 
##  labeling      0.3     2014-08-23 [1] CRAN (R 3.5.0)                 
##  lazyeval      0.2.1   2017-10-29 [1] CRAN (R 3.5.0)                 
##  magrittr    * 1.5     2014-11-22 [1] CRAN (R 3.5.0)                 
##  munsell       0.5.0   2018-06-12 [1] CRAN (R 3.5.0)                 
##  pander        0.6.3   2018-11-06 [1] CRAN (R 3.5.1)                 
##  pillar        1.3.1   2018-12-15 [1] CRAN (R 3.5.1)                 
##  pkgconfig     2.0.2   2018-08-16 [1] CRAN (R 3.5.1)                 
##  plyr          1.8.4   2016-06-08 [1] CRAN (R 3.5.0)                 
##  purrr         0.3.0   2019-01-27 [1] CRAN (R 3.5.2)                 
##  R6            2.3.0   2018-10-04 [1] CRAN (R 3.5.1)                 
##  Rcpp          1.0.0   2018-11-07 [1] CRAN (R 3.5.1)                 
##  rlang       * 0.3.1   2019-01-08 [1] CRAN (R 3.5.2)                 
##  rmarkdown     1.11    2018-12-08 [1] CRAN (R 3.5.1)                 
##  scales        1.0.0   2018-08-09 [1] CRAN (R 3.5.1)                 
##  sessioninfo   1.1.1   2018-11-05 [1] CRAN (R 3.5.1)                 
##  stringi       1.2.4   2018-07-20 [1] CRAN (R 3.5.1)                 
##  stringr       1.3.1   2018-05-10 [1] CRAN (R 3.5.0)                 
##  tibble        2.0.1   2019-01-12 [1] CRAN (R 3.5.2)                 
##  tidyselect    0.2.5   2018-10-11 [1] CRAN (R 3.5.1)                 
##  utf8          1.1.4   2018-05-24 [1] CRAN (R 3.5.0)                 
##  withr         2.1.2   2018-03-15 [1] CRAN (R 3.5.0)                 
##  xfun          0.4     2018-10-23 [1] CRAN (R 3.5.1)                 
##  yaml          2.2.0   2018-07-25 [1] CRAN (R 3.5.1)                 
## 
## [1] C:/Users/recleev/R/R-3.5.2/library</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references">
<div id="ref-R-data.table">
<p>Dowle, Matt, and Arun Srinivasan. 2018. <em>Data.table: Extension of ‘Data.frame‘</em>. <a href="https://CRAN.R-project.org/package=data.table" class="uri">https://CRAN.R-project.org/package=data.table</a>.</p>
</div>
<div id="ref-R-rlang">
<p>Henry, Lionel, and Hadley Wickham. 2018. <em>Rlang: Functions for Base Types and Core R and ’Tidyverse’ Features</em>. <a href="https://CRAN.R-project.org/package=rlang" class="uri">https://CRAN.R-project.org/package=rlang</a>.</p>
</div>
<div id="ref-bquote-winvector">
<p>Mount, John. n.d. “Quasiquotation in R via Bquote().” <a href="http://www.win-vector.com/blog/2018/10/quasiquotation-in-r-via-bquote/" class="uri">http://www.win-vector.com/blog/2018/10/quasiquotation-in-r-via-bquote/</a>.</p>
</div>
<div id="ref-R-ggplot2">
<p>Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen, Kohske Takahashi, Claus Wilke, and Kara Woo. 2018. <em>Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics</em>. <a href="https://CRAN.R-project.org/package=ggplot2" class="uri">https://CRAN.R-project.org/package=ggplot2</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>At least 8 hours a day, five days a week<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Whenever I want to review tidy evaluation and <code>rlang</code>, I always watch Hadley Wickham’s short but packed <a href="https://www.youtube.com/watch?v=nERXS3ssntw">video</a> about the topic.<a href="#fnref2">↩</a></p></li>
</ol>
</div>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="/post/loves-what-he-is-doing/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="/post/loves-what-he-is-doing/">A Person Who Loves What He is Doing</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'the-amateur-data-scientist';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="/js/ui.js"></script>






<script src="//https://amateurdatasci.rbind.io/js/math-code.js"></script>

    <script type="text/javascript"
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

</body>
</html>

