---
title: One Big Block to a Single Row Record
author: Recle E. Vibal
date: '2019-09-08'
categories:
  - data manipulation
  - data wrangling
  - lessons
tags:
  - baseR
  - cdata
slug: cdata-big-block-to-single-rowrec
description: A case study in data transformation with {cdata}
output:
  blogdown::html_page:
    toc: yes
    number_sections: yes
bibliography:
  - references/block-to-single-rowrec.bib
biblio-style: apalike
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/jquery/jquery.min.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/dt-ext-fixedcolumns/css/fixedColumns.dataTables.min.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-ext-fixedcolumns/js/dataTables.fixedColumns.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>

<div id="TOC">
<ul>
<li><a href="#on-the-job-puzzle"><span class="toc-section-number">1</span> On the Job Puzzle</a></li>
<li><a href="#control-inside-the-puzzle"><span class="toc-section-number">2</span> Control Inside the Puzzle</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<div id="on-the-job-puzzle" class="section level1">
<h1><span class="header-section-number">1</span> On the Job Puzzle</h1>
<pre class="r"><code>xfun::pkg_attach(
  &quot;knitr&quot;,
  &quot;cdata&quot;,
  &quot;tidyr&quot;,
  &quot;dplyr&quot;
)

opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)

# create standard datatable function to be used in all tables in this post
show_datatable &lt;- function(data) {
  data %&gt;% 
    DT::datatable(
      rownames = FALSE,
      extensions = &#39;FixedColumns&#39;,
      options = list(
        pageLength = 20,
        scrollX = TRUE,
        scrollCollapse = TRUE,
        columnDefs = list(
          list(
            className = &#39;dt-center&#39;,
            targets = 0:(ncol(data) - 1)
          )
        )
      )
    )
}</code></pre>
<p>In my current work, I encountered this data transformation problem.</p>
<pre class="r"><code>kingdom &lt;- c(&quot;North&quot;, &quot;South&quot;, &quot;East&quot;, &quot;West&quot;)
type &lt;- c(&quot;Light&quot;, &quot;Dark&quot;)
skill &lt;- c(&quot;Physical&quot;, &quot;Magical&quot;)
combat &lt;- c(&quot;Attack&quot;, &quot;Defense&quot;)

skill_groups &lt;- expand.grid(
  Kingdom = kingdom,
  Skill = skill,
  Type = type,
  stringsAsFactors = FALSE
)

combat_groups &lt;- expand.grid(
  Kingdom = kingdom,
  Combat = combat,
  Type = type,
  stringsAsFactors = FALSE
)

skill_combat_data &lt;- data.frame(
  SkillColumnName = paste0(
    skill_groups$Kingdom, 
    skill_groups$Skill, 
    skill_groups$Type
  ),
  SkillClass = c(
    &quot;D&quot;, &quot;E&quot;, &quot;C&quot;, &quot;B&quot;, &quot;D&quot;, &quot;C&quot;, 
    &quot;D&quot;, &quot;E&quot;, &quot;S&quot;, &quot;E&quot;, &quot;D&quot;, &quot;E&quot;, 
    &quot;C&quot;, &quot;E&quot;, &quot;E&quot;, &quot;S&quot;
  ),
  CombatColumnName = paste0(
    combat_groups$Kingdom, 
    combat_groups$Combat, 
    combat_groups$Type
  ),
  CombatPoints = c(
    25, 14, 47, 86, 25, 47, 
    25, 14, 107, 14, 25, 14, 
    47, 14, 14, 107
  ),
  stringsAsFactors = FALSE
)

skill_combat_data$ID &lt;- &quot;1aAMonJan&quot;

show_datatable(skill_combat_data)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","extensions":["FixedColumns"],"data":[["NorthPhysicalLight","SouthPhysicalLight","EastPhysicalLight","WestPhysicalLight","NorthMagicalLight","SouthMagicalLight","EastMagicalLight","WestMagicalLight","NorthPhysicalDark","SouthPhysicalDark","EastPhysicalDark","WestPhysicalDark","NorthMagicalDark","SouthMagicalDark","EastMagicalDark","WestMagicalDark"],["D","E","C","B","D","C","D","E","S","E","D","E","C","E","E","S"],["NorthAttackLight","SouthAttackLight","EastAttackLight","WestAttackLight","NorthDefenseLight","SouthDefenseLight","EastDefenseLight","WestDefenseLight","NorthAttackDark","SouthAttackDark","EastAttackDark","WestAttackDark","NorthDefenseDark","SouthDefenseDark","EastDefenseDark","WestDefenseDark"],[25,14,47,86,25,47,25,14,107,14,25,14,47,14,14,107],["1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan","1aAMonJan"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>SkillColumnName<\/th>\n      <th>SkillClass<\/th>\n      <th>CombatColumnName<\/th>\n      <th>CombatPoints<\/th>\n      <th>ID<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":20,"scrollX":true,"scrollCollapse":true,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3,4]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,20,25,50,100]}},"evals":[],"jsHooks":[]}</script>
<p>The data consists of this 16-row blocks for every <code>ID</code>. The goal is to convert this block into a single observation for every <code>ID</code>. I “inherited” this problem from a colleague with a solution using <code>tidyr::spread()</code><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a><span class="citation">(Wickham and Henry 2019)</span>. The solution looked something like this.</p>
<pre class="r"><code>skills &lt;- 
  skill_combat_data %&gt;% 
  as_tibble() %&gt;% 
  select(-CombatColumnName, -CombatPoints) %&gt;% 
  group_by(ID) %&gt;% 
  spread(key = SkillColumnName, value = SkillClass)

combat &lt;- 
  skill_combat_data %&gt;% 
  as_tibble() %&gt;% 
  select(-SkillColumnName, -SkillClass) %&gt;% 
  group_by(ID) %&gt;% 
  spread(key = CombatColumnName, value = CombatPoints)

skill_combat_spread &lt;- 
  skills %&gt;% 
  left_join(combat, by = &quot;ID&quot;)

show_datatable(skill_combat_spread)</code></pre>
<div id="htmlwidget-2" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"filter":"none","extensions":["FixedColumns"],"data":[["1aAMonJan"],["E"],["D"],["D"],["C"],["C"],["D"],["S"],["D"],["E"],["C"],["E"],["E"],["S"],["E"],["E"],["B"],[25],[47],[14],[25],[107],[25],[47],[25],[14],[14],[14],[47],[14],[86],[107],[14]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th>ID<\/th>\n      <th>EastMagicalDark<\/th>\n      <th>EastMagicalLight<\/th>\n      <th>EastPhysicalDark<\/th>\n      <th>EastPhysicalLight<\/th>\n      <th>NorthMagicalDark<\/th>\n      <th>NorthMagicalLight<\/th>\n      <th>NorthPhysicalDark<\/th>\n      <th>NorthPhysicalLight<\/th>\n      <th>SouthMagicalDark<\/th>\n      <th>SouthMagicalLight<\/th>\n      <th>SouthPhysicalDark<\/th>\n      <th>SouthPhysicalLight<\/th>\n      <th>WestMagicalDark<\/th>\n      <th>WestMagicalLight<\/th>\n      <th>WestPhysicalDark<\/th>\n      <th>WestPhysicalLight<\/th>\n      <th>EastAttackDark<\/th>\n      <th>EastAttackLight<\/th>\n      <th>EastDefenseDark<\/th>\n      <th>EastDefenseLight<\/th>\n      <th>NorthAttackDark<\/th>\n      <th>NorthAttackLight<\/th>\n      <th>NorthDefenseDark<\/th>\n      <th>NorthDefenseLight<\/th>\n      <th>SouthAttackDark<\/th>\n      <th>SouthAttackLight<\/th>\n      <th>SouthDefenseDark<\/th>\n      <th>SouthDefenseLight<\/th>\n      <th>WestAttackDark<\/th>\n      <th>WestAttackLight<\/th>\n      <th>WestDefenseDark<\/th>\n      <th>WestDefenseLight<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":20,"scrollX":true,"scrollCollapse":true,"columnDefs":[{"className":"dt-center","targets":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32]}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[10,20,25,50,100]}},"evals":[],"jsHooks":[]}</script>
<p>The solution works fine, but I felt uncomfortable using two calls of spread on the data. As the data grows this can be a problem. I wanted a simpler workflow too, as this looks too synthetic. I decided I wanted to use <code>{cdata}</code> <span class="citation">(Mount and Zumel 2019)</span>.</p>
<p>However, the <code>{cdata}</code> workflow did not come to my mind immediately as the data has the column names and the column values side-by-side. It took me some time to find the solution.</p>
</div>
<div id="control-inside-the-puzzle" class="section level1">
<h1><span class="header-section-number">2</span> Control Inside the Puzzle</h1>
<pre class="r"><code>skill_combat_control_table &lt;- skill_combat_data

# The values of SkillClass and CombatPoints should be converted to row records
# with column names from SkillColumnName and CombatColumnName
skill_combat_control_table$SkillClass &lt;- skill_combat_data$SkillColumnName
skill_combat_control_table$CombatPoints &lt;- skill_combat_data$CombatColumnName
# ID is not needed in the control table
skill_combat_control_table$ID &lt;- NULL

skill_combat_rowrec &lt;- cdata::blocks_to_rowrecs(
  skill_combat_data,
  keyColumns = &quot;ID&quot;,
  controlTableKeys = c(&quot;SkillColumnName&quot;, &quot;CombatColumnName&quot;),
  controlTable = skill_combat_control_table
)</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references">
<div id="ref-R-cdata">
<p>Mount, John, and Nina Zumel. 2019. <em>Cdata: Fluid Data Transformations</em>. <a href="https://CRAN.R-project.org/package=cdata">https://CRAN.R-project.org/package=cdata</a>.</p>
</div>
<div id="ref-R-tidyr">
<p>Wickham, Hadley, and Lionel Henry. 2019. <em>Tidyr: Easily Tidy Data with ’Spread()’ and ’Gather()’ Functions</em>. <a href="https://CRAN.R-project.org/package=tidyr">https://CRAN.R-project.org/package=tidyr</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>I <a href="https://amateurdatasci.rbind.io/post/table-another-back-again-cdata/">know</a> that <code>spread()</code> will be deprecated in favor of <code>tidyr::pivot_wider()</code>, so the solution my colleague gave me will need to change. This is one reason why I wanted to adapt a different approach to solve this problem.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
